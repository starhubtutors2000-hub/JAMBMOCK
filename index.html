<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>StarHub CBT Mock Test - Login</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #ffffff; /* white background */
    margin: 0; padding: 0;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
  }

  .card {
    background: #fff;
    padding: 30px 25px;
    border-radius: 12px;
    box-shadow: 0 6px 20px rgba(0,0,0,0.1);
    width: 90%;
    max-width: 400px;
    text-align: center;
  }

  h2 {
    color: #0b3d0b; /* dark green accent */
    margin-bottom: 20px;
  }

  input {
    width: 100%;
    padding: 12px;
    margin: 10px 0 16px 0;
    border-radius: 6px;
    border: 1px solid #0b3d0b;
    font-size: 16px;
  }

  button {
    width: 50%;
    padding: 10px;
    border: none;
    background: #0b3d0b; /* dark green button */
    color: #fff;
    font-size: 16px;
    border-radius: 6px;
    cursor: pointer;
    transition: background 0.3s;
  }

  button:hover {
    background: #065006;
  }

  .status {
    text-align: center;
    margin-top: 15px;
    font-weight: bold;
    color: #b00000;
  }

  @media (max-width: 500px) {
    h2 { font-size: 20px; }
    input, button { font-size: 14px; padding: 8px; }
    button { width: 70%; }
  }
</style>
</head>
<body>

<div class="card">
  <h2>StarHub CBT Mock Test</h2>
  <input type="text" id="candidateName" placeholder="Enter your full name" />
  <button id="loginBtn">Start Exam</button>
  <div class="status" id="status"></div>
</div>
<!-- Firebase SDK first -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script>
  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyBQHoqSFbY_Z4DbwGbFzrPg2chbE7gdS04",
    authDomain: "starhub-cbt-system.firebaseapp.com",
    projectId: "starhub-cbt-system",
    storageBucket: "starhub-cbt-system.appspot.com",
    messagingSenderId: "738358959988",
    appId: "1:738358959988:web:5ba5600cc7b6d107add621",
    measurementId: "G-QD9766ZNVJ"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const loginBtn = document.getElementById('loginBtn');
  const status = document.getElementById('status');
  const candidateNameInput = document.getElementById('candidateName');

  function getDeviceFingerprint() {
    return navigator.userAgent + "-" + navigator.platform + "-" + screen.width + "x" + screen.height;
  }

  loginBtn.addEventListener('click', async () => {
    const name = candidateNameInput.value.trim();
    if (!name) { 
      status.textContent = "❌ Please enter your full name"; 
      return; 
    }

    try {
      // Fetch exam settings
      const settingsRef = db.collection("settings").doc("examConfig");
      const docSnap = await settingsRef.get();
      if (!docSnap.exists) { 
        status.textContent = "❌ Exam configuration not set by admin"; 
        return; 
      }

      const examData = docSnap.data();
      const examStartTime = new Date(examData.startTime);
      const examEndTime   = new Date(examData.endTime);
      const now = new Date();

      if (now < examStartTime) { status.textContent = "⏳ Exam has not started yet"; return; }
      if (now > examEndTime) { status.textContent = "⌛ Exam is over"; return; }

      // Fingerprint placeholder for session
      const fingerprint = getDeviceFingerprint();
      localStorage.setItem("candidateFingerprint", fingerprint);
      // Store a simple placeholder IP for GitHub Pages
      localStorage.setItem("candidateIP", "online");

      // Check if candidate already exists
      const querySnapshot = await db.collection("candidates").where("name", "==", name).get();
      let alreadyTaken = false;
      querySnapshot.forEach(doc => { 
        if(doc.data().fingerprint === fingerprint) alreadyTaken = true; 
      });

      if (alreadyTaken) { 
        status.textContent = "❌ Access denied. You have already taken this exam"; 
        return; 
      }

      // Add candidate
      await db.collection("candidates").add({
        name, 
        fingerprint, 
        IP: "online",
        loginTime: firebase.firestore.Timestamp.now()
      });

      localStorage.setItem("candidateName", name);
      status.textContent = "✅ Access granted. Redirecting...";
      setTimeout(() => window.location.href = "starpage2.html", 1000);

    } catch(err) {
      console.error(err);
      status.textContent = "❌ Error accessing Firestore";
    }
  });
</script>
</body>
                                                                                 </html>
